# mle-template-case-sprint2

Добро пожаловать в репозиторий-шаблон Практикума для проекта 2 спринта. Ваша цель — улучшить ключевые метрики модели для предсказания стоимости квартир Яндекс Недвижимости.

Полное описание проекта хранится в уроке «Проект. Улучшение baseline-модели» на учебной платформе.

Здесь укажите имя вашего бакета: ```s3-student-mle-20240228-2fd44f5a96```

# Установка репозитория и зависимостей

```
git clone git@github.com:FrostyFrost/mle-project-sprint-2-v001.git
cd mle-project-sprint-2-v001

sudo apt-get update
sudo apt-get install python3.10-venv
python3.10 -m venv .venv_sprint02
source .venv_sprint02/bin/activate

pip install -r requirements.txt 
```
# Этап 1: Разворачивание MLflow и регистрация модели

```
export $(cat .env | xargs)
sh mlflow_server/server_start.sh 
```
Для регистрации первой версии модели запустить скрипт 
```
python mlflow_server/register_model.py 
```

В проекте модель зарегистрирована под именем:
```
REGISTRY_MODEL_NAME = "estate_model"

Experiment ID: 9

Artifact Location: s3://s3-student-mle-20240228-2fd44f5a96/9
```
Запуск  __baseline__ - исходная модель с CatBoostEncoder и StandardScaler


# Этап 2: Проведение EDA

Основные выводы:
1. В целом, видно что каждый building_type характерен своими признаками. Можно предположить, что:

    * building_type_int = 3 - частные дома с большой площадью

    * building_type_int = 4 - относительно новые дома с низкими потолками и малой площадью. Вероятно квартиры-студии

    * building_type_int = 5 - "сталинки" с высокими потолками и старой постройкой 


2. В целом, сильно коррелирующих признаков нет. Можно отметить лишь следующее:

    * Достаточно сильная корреляция между количеством комнат, жилой и общей площадью (что логично). Вероятно стоит оставить только одну общую площадь

    * Средняя корреляция между годом постройки и количеством этажей


3. Есть странные цены на квартиры - то ли указаны в долларах, то ли это доля от квартиры, то ли что-то еще. Вероятно, будут влиять на качество. неплохо бы понять, имеется ли тут ошибка в цене.


4. Наблюдается кластер невысоких этажей с низкой ценой, котрый не связан с типом ```building_type_int```


5. Для разных ```building_type_int``` разные распределения по цене


6. Сильной зависимости от этажа нет. Самые дорогие квартиры обычно ниже 10 этажа


7. При цене до 12 млн зависимости от площади квартиры практически нет. Дороже 12 млн - цена растет экспоненциально 

8. Имеет смысл выделить первый и последний этаж в отдельные переменные

Артефакты сохранены в запуске ```baseline_eda```


# Этап 3: Генерация признаков и обучение модели

На данном этапе первоначально генерируем числовые признаки с помощью пробразования StandardScaler, PolynomialFeatures, KBinsDiscretizer

Запуск имеет название ```feature_transforming```

Далее применен AutoFeatRegressor, сгенерировано 8 новых признаков и добавлено в модель

Запуск имеет название ```feature_transforming_w_af```

Эти действия привели к улучшению качества по метрике MAPE, но увеличению MAE, MSE

# Этап 4: Отбор признаков и обучение новой версии модели

Для отбора использовались SequentialFeatureSelector (как forward, так и backward) и RFECV.

Итоговый набор создан как объединение признаков, выявленных всеми тремя подходами. Всего отобрано 68 признаков.
Признаки сохранены в 
_s3://s3-student-mle-20240228-2fd44f5a96/9/6ba6e7283e45404380d477d17a9a1ef0/artifacts/selected_features.txt_ 
Объкты sfs, sbs, rfecv сохранены в запуске ```feature_selection```

Отбор признаков несколько улучшил предыдущие результаты

# Этап 5: Подбор гиперпараметров и обучение новой версии модели

Подбор гиперпараметров осуществлялся с помощью optuna (запуск ```hyperparams_optuna_```)
и RandomizedSearchCV (запуск ```hyperparams_random_search```). Параметры, полученные разными подходами сильно разнятся кроме learning_rate. Оптимальные будем смотреть по тестовой выборке. 

Лучшие результаты показала модель с параметрами, полученными optuna, она и взята за итоговую модель.
В финальном запуске ```final_pipeline``` сохранены шаги, наборы признаков и параметры модели.

Финальная модель улучшила качество по сравнению с базовой по метрикам MAPE и MAE. MSE оказалось немного хуже.


